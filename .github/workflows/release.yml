name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Determine release type
        id: release_type
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          if [[ "$TAG" == *"-beta"* ]] || [[ "$TAG" == *"-alpha"* ]] || [[ "$TAG" == *"-rc"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "latest=false" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "latest=true" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog
        id: changelog
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Extract section for this version from CHANGELOG.md
          NOTES=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if (index($0, ver)) found=1
              next
            }
            found {print}
          ' CHANGELOG.md)

          # Fallback if no changelog entry found
          if [ -z "$NOTES" ]; then
            NOTES="Release $TAG"
          fi

          # Write to file to preserve newlines
          echo "$NOTES" > /tmp/release_notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.release_type.outputs.tag }}"
          PRERELEASE="${{ steps.release_type.outputs.prerelease }}"
          LATEST="${{ steps.release_type.outputs.latest }}"

          ARGS="--title $TAG --notes-file /tmp/release_notes.md"

          if [ "$PRERELEASE" = "true" ]; then
            ARGS="$ARGS --prerelease"
          fi

          if [ "$LATEST" = "true" ]; then
            ARGS="$ARGS --latest"
          fi

          gh release create "$TAG" $ARGS
